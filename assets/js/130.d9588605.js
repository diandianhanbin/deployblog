(window.webpackJsonp=window.webpackJsonp||[]).push([[130],{362:function(s,t,a){"use strict";a.r(t);var n=a(0),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"背景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[s._v("#")]),s._v(" 背景")]),s._v(" "),a("p",[s._v("最近准备重构博客，看了一下"),a("code",[s._v("Flask")]),s._v("更新到了1.0了，于是抽时间看了一下更新的内容。具体的变动信息请参考"),a("a",{attrs:{href:"http://flask.pocoo.org/docs/1.0/changelog/",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方文档"),a("OutboundLink")],1),s._v("。刚好在腾讯云上买了台服务器，于是想着用"),a("code",[s._v("Python3.6")]),s._v("来重写博客。")]),s._v(" "),a("h2",{attrs:{id:"flask1-0支持版本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#flask1-0支持版本"}},[s._v("#")]),s._v(" Flask1.0支持版本")]),s._v(" "),a("p",[a("code",[s._v("Flask")]),s._v("1.0之后，不再支持"),a("code",[s._v("Python2.6")]),s._v("和"),a("code",[s._v("Python3.3")]),s._v("。")]),s._v(" "),a("h2",{attrs:{id:"flask1-0的启动方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#flask1-0的启动方式"}},[s._v("#")]),s._v(" Flask1.0的启动方式")]),s._v(" "),a("p",[s._v("此项改动应该是本次最大的变动了。")]),s._v(" "),a("ul",[a("li",[s._v("普通模式")])]),s._v(" "),a("p",[s._v("传统的方式是在入口文件中写入"),a("code",[s._v("app.run()")]),s._v("，如果需要调试模式，则使用"),a("code",[s._v("app.run(DEBUG=True)")]),s._v("，最后使用"),a("code",[s._v("python app.py")]),s._v("运行主文件。")]),s._v(" "),a("p",[s._v("更新为1.0之后，启动方式改了。")]),s._v(" "),a("p",[s._v("入口文件中无需写"),a("code",[s._v("app.run()")]),s._v(".而是在环境变量中加入"),a("code",[s._v("FLASK_APP=hello.py")]),s._v("，然后用命令"),a("code",[s._v("python -m flask run")]),s._v("即可启动服务。")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[s._v("  python "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("m flask run\n "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" Serving Flask app "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello.py"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("lazy loading"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" Environment"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" development\n "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" Debug mode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" on\n "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" Running on http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Press CTRL"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("C to quit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" Restarting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("with")]),s._v(" stat\n "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" Debugger "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("is")]),s._v(" active!\n "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" Debugger PIN"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("281")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("319")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("154")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("如果需要调试模式，则在环境变量中添加"),a("code",[s._v("FLASK_ENV=development")]),s._v("。")]),s._v(" "),a("p",[s._v("如果需要整个局域网都可见此服务，则在启动参数中增加"),a("code",[s._v("--host=0.0.0.0")])]),s._v(" "),a("ul",[a("li",[s._v("工厂函数")])]),s._v(" "),a("p",[s._v("此方法也是官方比较推荐的方式，在主目录下建一个"),a("code",[s._v("__init__.py")]),s._v("文件，里面代码如下：")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" flask "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" Flask\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("create_app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("test_config"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("None")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# create and configure the app")]),s._v("\n    app "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Flask"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("__name__"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" instance_relative_config"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("from_mapping"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n        SECRET_KEY"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'dev'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" test_config "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("is")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("None")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# load the instance config, if it exists, when not testing")]),s._v("\n        app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("from_pyfile"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'config.py'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" silent"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# load the test config if passed in")]),s._v("\n        app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("from_mapping"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("test_config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ensure the instance folder exists")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        os"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("makedirs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("instance_path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("except")]),s._v(" OSError"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("pass")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# a simple page that says hello")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[s._v("@app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("route")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/hello'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("hello")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Hello, World!'")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" app\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br")])]),a("p",[s._v("然后在主文件中写入：")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" create_app\n\napp "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" create_app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("启动方式同普通模式一样即可。")]),s._v(" "),a("ul",[a("li",[s._v("在生产环境启动")])]),s._v(" "),a("p",[s._v("最终写完的内容还是要部署到生产的，在生产一般来说用"),a("code",[s._v("uwsgi")]),s._v("或者"),a("code",[s._v("gunicorn")]),s._v("比较多，本次我用的是"),a("code",[s._v("gunicorn")]),s._v("来部署。"),a("code",[s._v("gunicorn")]),s._v("是支持协程的方式部署的，性能较之前有比较大的提升，具体的执行脚本如下：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("FLASK_APP")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("app.py\ngunicorn -w "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" -b "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:8000 -k gevent main.app:app\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("附上重启的方式：")]),s._v(" "),a("p",[s._v("执行"),a("code",[s._v("pstree -ap|grep gunicorn")]),s._v("就可以看到"),a("code",[s._v("gunicorn")]),s._v("执行的主进程号，执行"),a("code",[s._v("kill HUB 主进程号")]),s._v("即可重启，再次查看的时候会发现子进程号已经更新了。")]),s._v(" "),a("h2",{attrs:{id:"python3-6的坑"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#python3-6的坑"}},[s._v("#")]),s._v(" Python3.6的坑")]),s._v(" "),a("ul",[a("li",[s._v("缺失SSL")])]),s._v(" "),a("p",[s._v("使用最新的方式难免会要踩坑，最新的"),a("code",[s._v("Python3")]),s._v("在编译的过程中，是没有带上"),a("code",[s._v("SSL")]),s._v("的，但是在使用"),a("code",[s._v("pip3")]),s._v("的时候，需要"),a("code",[s._v("ssl")]),s._v("的支持，这是一个巨大的坑。解决方案是在"),a("code",[s._v("make")]),s._v("之前执行的"),a("code",[s._v("./configure")]),s._v("中加上这些参数"),a("code",[s._v("./configure –prefix=/usr/local/python3 --with-ssl")]),s._v("。\n其中"),a("code",[s._v("–prefix=/usr/local/python3")]),s._v("表示"),a("code",[s._v("make")]),s._v("后安装的路径，而"),a("code",[s._v("--with-ssl")]),s._v("则是编译的过程中需要加上"),a("code",[s._v("ssl")]),s._v("，否则在使用"),a("code",[s._v("pip")]),s._v("时会报：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("pip is configured with locations that require TLS/SSL, however the ssl module in Python is not available.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[s._v("缺失zlib")])]),s._v(" "),a("p",[s._v("在编译python3的时候，报了这个错，"),a("code",[s._v("zipimport.ZipImportError: can’t decompress data; zlib not available")]),s._v("，意思就是缺少了"),a("code",[s._v("zlib")]),s._v("这个库，在编译之前需要执行"),a("code",[s._v("yum -y install zlib*")])]),s._v(" "),a("h2",{attrs:{id:"博客的重构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#博客的重构"}},[s._v("#")]),s._v(" 博客的重构")]),s._v(" "),a("p",[s._v("本次的博客重构如题所说用了"),a("code",[s._v("Python3.6")]),s._v("和"),a("code",[s._v("Flask1.0")]),s._v("，算是用比较新的方式来开发，前端用的是"),a("code",[s._v("Vue.js")]),s._v("+"),a("code",[s._v("Bootstrap")]),s._v("来处理样式，整体的样式都是非常简单的。而前后端交互用了"),a("code",[s._v("flask_restful")]),s._v("库。使用了"),a("code",[s._v("RESTful")]),s._v("风格的接口，让整个接口的接口看起来更清晰。功能暂时只做了一个展示，算是从新浪云的服务器彻底的迁移了吧，后续还要慢慢完善统计的功能。")]),s._v(" "),a("p",[s._v("全新编写的同时，去掉了以往的统计数据，这些东西只能全部重新来收集了。")]),s._v(" "),a("p",[s._v("整个过程看起来好像没什么内容，实际上整整花了近两天的时间，遇到的很多小细节的问题没办法每个都列出来，但是整个部署的过程也是一个学习的过程，毕竟在一个全新的环境上部署，还是有很多坑要踩的。")]),s._v(" "),a("h2",{attrs:{id:"后续的计划"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#后续的计划"}},[s._v("#")]),s._v(" 后续的计划")]),s._v(" "),a("p",[s._v("博客的CMS，统计，用户权限，留言等内容都还没有做完，剩下的路还有很多。")]),s._v(" "),a("h2",{attrs:{id:"最后"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#最后"}},[s._v("#")]),s._v(" 最后")]),s._v(" "),a("p",[s._v("欢迎参观"),a("a",{attrs:{href:"http://www.wengyb.com",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://www.wengyb.com"),a("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=e.exports}}]);