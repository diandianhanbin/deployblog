(window.webpackJsonp=window.webpackJsonp||[]).push([[133],{362:function(s,t,n){"use strict";n.r(t);var a=n(0),e=Object(a.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h2",{attrs:{id:"背景"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[s._v("#")]),s._v(" 背景")]),s._v(" "),n("p",[s._v("最近我们在整一个云执行的平台，底层用的是"),n("code",[s._v("Jenkins")]),s._v("来做执行引擎，方便的把我们的脚本做一个统一的调度。")]),s._v(" "),n("p",[n("code",[s._v("Jenkins")]),s._v("确实是一个非常方便的框架，它提供了一整套的"),n("code",[s._v("RESTful")]),s._v("的API，可以非常方便的做二次开发，而且提供了一个"),n("code",[s._v("python")]),s._v("的库，操作起来就更加方便了。")]),s._v(" "),n("h2",{attrs:{id:"常用的jenkins概念"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#常用的jenkins概念"}},[s._v("#")]),s._v(" 常用的Jenkins概念")]),s._v(" "),n("p",[s._v("我们在使用"),n("code",[s._v("Jenkins")]),s._v("的时候，一般看到的都是"),n("code",[s._v("Jenkins的View")]),s._v("。")]),s._v(" "),n("p",[s._v("也就是说我们看到的基本上都是一些视图。")]),s._v(" "),n("p",[s._v("每一个构建的内容，无论是执行用例，跑脚本，还是打包编译发布，都是一个"),n("code",[s._v("job")]),s._v("。")]),s._v(" "),n("p",[s._v("每一个"),n("code",[s._v("job")]),s._v("都有一个对应的"),n("code",[s._v("name")]),s._v("，如果这个"),n("code",[s._v("job")]),s._v("被放在某个文件夹了，那么"),n("code",[s._v("name")]),s._v("就是文件夹名+job名。在查看"),n("code",[s._v("job")]),s._v("信息的时候，会返回一个"),n("code",[s._v("full_name")]),s._v("字段，指的就是这个了。")]),s._v(" "),n("h2",{attrs:{id:"pythonsdk"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#pythonsdk"}},[s._v("#")]),s._v(" PythonSDK")]),s._v(" "),n("p",[n("code",[s._v("pip install python-jenkins")]),s._v("执行这条命令就可以安装SDK了。")]),s._v(" "),n("p",[s._v("官网："),n("code",[s._v("https://pypi.org/project/python-jenkins/")])]),s._v(" "),n("p",[s._v("说明文档："),n("code",[s._v("http://python-jenkins.readthedocs.io/en/latest/")])]),s._v(" "),n("p",[s._v("说明文档都是英文的，如果有兴趣，看这块当然最好，不过这个SDK实际上非常非常的简单，如果直接去看源代码，也是没问题的，我在开发的过程中，基本上都是去看源码来写的，SDK里面函数命名比较直白，不用深刻理解也能够正常的去使用。")]),s._v(" "),n("p",[s._v("这里列一些比较常用的方法，也是我这次开发的时候用到的一些，我按照我自己写的过程中，一步一步的写出来。")]),s._v(" "),n("h2",{attrs:{id:"开发过程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#开发过程"}},[s._v("#")]),s._v(" 开发过程")]),s._v(" "),n("ul",[n("li",[s._v("job信息查询")])]),s._v(" "),n("p",[s._v("在"),n("code",[s._v("Jenkins")]),s._v("中，每一个构建都是一个"),n("code",[s._v("job")]),s._v("，所以，我们做开发的时候，要在页面上展示历史的构建信息，因此，要能够拿到"),n("code",[s._v("历史执行job")]),s._v("的信息。因此我们要使用"),n("code",[s._v("get_job_info")]),s._v("这个方法。")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[s._v("    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("get_job_info")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" depth"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" fetch_all_builds"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("False")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v("'''Get job information dictionary.\n\n        :param name: Job name, ``str``\n        :param depth: JSON depth, ``int``\n        :param fetch_all_builds: If true, all builds will be retrieved\n                                 from Jenkins. Otherwise, Jenkins will\n                                 only return the most recent 100\n                                 builds. This comes at the expense of\n                                 an additional API call which may\n                                 return significant amounts of\n                                 data. ``bool``\n        :returns: dictionary of job information\n        '''")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("这里的"),n("code",[s._v("name")]),s._v("参数指的是"),n("code",[s._v("job")]),s._v("的名字，比如我新建了一个叫"),n("code",[s._v("自动化测试")]),s._v("这么个"),n("code",[s._v("job")]),s._v("，那么这个"),n("code",[s._v("name")]),s._v("传的就是"),n("code",[s._v("自动化测试")]),s._v("，如果我把这个"),n("code",[s._v("job")]),s._v("放到了某个文件夹中，那么"),n("code",[s._v("name")]),s._v("这个参数需要传"),n("code",[s._v("文件夹名/自动化测试")]),s._v("。\n这里有一个坑，在"),n("code",[s._v("Python2.7")]),s._v("版本中传递这个"),n("code",[s._v("name")]),s._v("，如果以变量的形式传递过去，会有一个报错，规避的方法是"),n("code",[s._v("name.encode('utf-8')")]),s._v("做一下编码的处理。返回的参数是这些：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://blog-img-1251534856.cos.ap-guangzhou.myqcloud.com/1537775114.494164.jpg",alt:""}})]),s._v(" "),n("p",[s._v("在"),n("code",[s._v("builds")]),s._v("字段里面就存有所有的历史构建数据。在"),n("code",[s._v("property")]),s._v("这个字段中放有"),n("code",[s._v("Jenkins")]),s._v("构建时的各种参数。")]),s._v(" "),n("ul",[n("li",[s._v("构建日志")])]),s._v(" "),n("p",[s._v("拿到了构建数据，我们需要在页面上展示出来，如果能在页面上直接看日志就更方便了，因此要把每次的构建日志拿出来，需要调用"),n("code",[s._v("get_build_console_output")]),s._v("这个方法。")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[s._v("    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("get_build_console_output")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" number"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v("'''Get build console text.\n\n        :param name: Job name, ``str``\n        :param number: Build number, ``int``\n        :returns: Build console output,  ``str``\n        '''")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("这里可以拿到"),n("code",[s._v("Jenkins")]),s._v("的构建日志，返回的就是一个字符串了。需要注意的是，如果你想要构建的时候也展示构建日志，只需要在构建的时候调用这个方法就行，会返回调用时候构建的日志，用"),n("code",[s._v("socket")]),s._v("或者"),n("code",[s._v("轮询")]),s._v("的方式都可以实现实时日志的展示。")]),s._v(" "),n("ul",[n("li",[s._v("执行构建")])]),s._v(" "),n("p",[s._v("执行构建当然是非常关键的一步，我们可以使用"),n("code",[s._v("build_job")]),s._v("这个方法来执行构建。")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[s._v("    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("build_job")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" parameters"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("None")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" token"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("None")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v("'''Trigger build job.\n\n        This method returns a queue item number that you can pass to\n        :meth:`Jenkins.get_queue_item`. Note that this queue number is only\n        valid for about five minutes after the job completes, so you should\n        get/poll the queue information as soon as possible to determine the\n        job's URL.\n\n        :param name: name of job\n        :param parameters: parameters for job, or ``None``, ``dict``\n        :param token: Jenkins API token\n        :returns: ``int`` queue item\n        '''")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("这里的"),n("code",[s._v("name")]),s._v("参数跟"),n("code",[s._v("job信息查询")]),s._v("的参数一样，也会有编码的问题。"),n("code",[s._v("parameters")]),s._v("字段传入的是一个字典类型，也就是在页面上点击构建的时候，需要填入的参数。"),n("code",[s._v("token")]),s._v("参数在"),n("code",[s._v("Jenkins")]),s._v("这个类初始化的时候就已经有了，所以一般来说无需传入。这个方法会返回一个"),n("code",[s._v("queue_item")]),s._v("的编号，这个就是"),n("code",[s._v("Jenkins")]),s._v("的构建编号，这个编号可以做一些其他数据的查询，比如构建状态，取消构建等操作，在SDK里面都有对应的方法。")]),s._v(" "),n("p",[s._v("**注意：**绝对不行用这个来查询是否处于构建中，这个编号在一定时间内会出现失效的情况，如果构建时间过长，会导致查询不到结果而报错，实际上"),n("code",[s._v("job")]),s._v("依然处于构建中")]),s._v(" "),n("p",[s._v("这些方法使用起来比较方便，但是有一些局限性，我们如果在构建的时候用了第三方插件，这些方法是没办法拿到第三方插件的结果的，比如我们这里用"),n("code",[s._v("RobotFramework")]),s._v("的插件来处理了结果，用这些方法是没办法拿到结果的。")]),s._v(" "),n("h2",{attrs:{id:"从原理入手"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#从原理入手"}},[s._v("#")]),s._v(" 从原理入手")]),s._v(" "),n("p",[n("code",[s._v("Jenkins")]),s._v("对外提供的是一个"),n("code",[s._v("RESTful")]),s._v("的接口，那么"),n("code",[s._v("Python的SDK")]),s._v("做的动作实际上就是去请求这个接口，只不过做了一些包装，保证了易用性，很多方法的核心，都会用到"),n("code",[s._v("jenkins_request")]),s._v("，比如：")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[s._v("response "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("jenkins_request"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("requests"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Request"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'POST'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("build_job_url"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" parameters"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" token"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("有兴趣的可以自己去读一读源码，整个"),n("code",[s._v("SDK")]),s._v("实际上就是基于"),n("code",[s._v("requests")]),s._v("这个库做了一下包装，然后最终都是通过"),n("code",[s._v("jenkins_request")]),s._v("去请求"),n("code",[s._v("RESTful")]),s._v("的API。我们进入"),n("code",[s._v("jenkins")]),s._v("的页面，在右下角能看到一个这样的东西。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://blog-img-1251534856.cos.ap-guangzhou.myqcloud.com/1537775145.797475.jpg",alt:""}})]),s._v(" "),n("p",[s._v("有这个标记的页面，就是有接口的，那么这个接口是怎么拿的呢？")]),s._v(" "),n("p",[s._v("从源码里面可以找到答案，很多方法里面都有这么样一个东西。")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[s._v("self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("jenkins_open"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("requests"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Request"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'GET'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("_build_url"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("INFO"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("auth"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("auth"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                        add_crumb"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("False")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" resolve_auth"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("False")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                        \nresponse "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("jenkins_open"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("requests"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Request"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'GET'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("_build_url"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("BUILD_INFO"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("locals")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("在最上方的配置中可以找到："),n("code",[s._v("INFO = 'api/json'")])]),s._v(" "),n("p",[s._v("也就是说，在我们看到页面的后方加上"),n("code",[s._v("/api/json")]),s._v("就可以拿到数据了。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://blog-img-1251534856.cos.ap-guangzhou.myqcloud.com/1537775249.7763999.jpg",alt:""}})]),s._v(" "),n("p",[s._v("所有的操作都在这个数据的背后了，也就是说只要写好这个url的拼接规则，就能很简单的去做二次开发了。")]),s._v(" "),n("p",[s._v("当然，在开发的过程中，也是有很多坑的，比如拿历史数据的时候，接口竟然不返回历史构建的状态。。。。")]),s._v(" "),n("h2",{attrs:{id:"总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),n("p",[s._v("整个开发过程下来还算比较顺利，由于源码比较简单的原因，基本上遇到问题都能通过看源码来解决，但是比较大的问题就是返回结果的枚举没有一个地方列出来，所以导致开发完成后经常有地方需要修修补补。")])])}),[],!1,null,null,null);t.default=e.exports}}]);